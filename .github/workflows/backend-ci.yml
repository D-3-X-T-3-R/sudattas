name: Backend CI/CD

on:
  push:
    branches: [ main, master, develop ]
    paths:
      - 'backend/**'
      - '.github/workflows/backend-ci.yml'
  pull_request:
    branches: [ main, master, develop ]
    paths:
      - 'backend/**'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ============================================================================
  # Job 1: Lint and Format Check
  # ============================================================================
  lint:
    name: Lint and Format
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@nightly
      with:
        components: rustfmt, clippy

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache cargo index
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache cargo build
      uses: actions/cache@v4
      with:
        path: backend/target
        key: ${{ runner.os }}-cargo-build-${{ hashFiles('**/Cargo.lock') }}

    - name: Install protobuf compiler
      run: |
        sudo apt-get update
        sudo apt-get install -y protobuf-compiler
        protoc --version

    - name: Check formatting
      working-directory: ./backend
      run: cargo fmt --all -- --check

    - name: Clippy
      working-directory: ./backend
      run: cargo clippy --all-targets --all-features -- -D warnings

  # ============================================================================
  # Job 2: Build and Test
  # ============================================================================
  test:
    name: Build and Test
    runs-on: ubuntu-latest
    needs: lint
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: test_password
          MYSQL_DATABASE: sudattas_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd "mysqladmin ping -h localhost"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@nightly

    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          backend/target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Install protobuf compiler
      run: |
        sudo apt-get update
        sudo apt-get install -y protobuf-compiler libprotobuf-dev
        protoc --version

    - name: Setup test database
      env:
        MYSQL_HOST: 127.0.0.1
        MYSQL_PORT: 3306
        MYSQL_USER: root
        MYSQL_PASSWORD: test_password
      run: |
        # Wait for MySQL to be ready
        sleep 10
        # 01_schema.sql creates and uses database SUDATTAS; run without specifying DB so tables go there
        mysql -h 127.0.0.1 -P 3306 -u root -ptest_password < backend/database/sql_dump/01_schema.sql
        echo "Database schema loaded successfully"

    - name: Regenerate entities and verify
      run: |
        cargo install sea-orm-cli
        sea-orm-cli generate entity \
          -u "mysql://root:test_password@127.0.0.1:3306/SUDATTAS" \
          -o backend/core_db_entities/src/entity \
          --with-serde both \
          --date-time-crate chrono \
          --max-connections 1
        if ! git diff --exit-code backend/core_db_entities/src/entity; then
          echo "::error::Entity files are out of sync with schema. Run: sea-orm-cli generate entity -u 'mysql://root:test_password@127.0.0.1:3306/SUDATTAS' -o backend/core_db_entities/src/entity --with-serde both --date-time-crate chrono"
          exit 1
        fi

    - name: Run unit tests
      working-directory: ./backend
      run: cargo test --lib --bins --tests --all-features --no-fail-fast -- --skip ignored

    - name: Run integration tests
      working-directory: ./backend
      env:
        TEST_DATABASE_URL: mysql://root:test_password@127.0.0.1:3306/SUDATTAS
      run: cargo test --test integration_critical_paths --all-features -- --ignored

    - name: Run doc tests
      working-directory: ./backend
      run: cargo test --doc --all-features

  # ============================================================================
  # Job 3: Security Audit
  # ============================================================================
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@nightly

    - name: Install cargo-audit
      run: cargo install cargo-audit

    - name: Run security audit
      working-directory: ./backend
      run: cargo audit

  # ============================================================================
  # Job 4: Code Coverage
  # ============================================================================
  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    needs: test
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: test_password
          MYSQL_DATABASE: sudattas_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd "mysqladmin ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@nightly

    - name: Install protobuf compiler
      run: |
        sudo apt-get update
        sudo apt-get install -y protobuf-compiler
        protoc --version

    - name: Setup test database
      run: |
        sleep 10
        mysql -h 127.0.0.1 -P 3306 -u root -ptest_password < backend/database/sql_dump/01_schema.sql

    - name: Install tarpaulin
      run: cargo install cargo-tarpaulin

    - name: Generate coverage
      working-directory: ./backend
      env:
        TEST_DATABASE_URL: mysql://root:test_password@127.0.0.1:3306/SUDATTAS
      run: cargo tarpaulin --all-features --workspace --timeout 300 --out Xml

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: ./backend/cobertura.xml
        flags: backend
        fail_ci_if_error: false

  # ============================================================================
  # Job 5: Build Check (Ensure it compiles)
  # ============================================================================
  build:
    name: Build Check
    runs-on: ubuntu-latest
    needs: test
    strategy:
      matrix:
        rust: [stable, nightly]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: ${{ matrix.rust }}

    - name: Install protobuf compiler
      run: |
        sudo apt-get update
        sudo apt-get install -y protobuf-compiler
        protoc --version

    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          backend/target
        key: ${{ runner.os }}-${{ matrix.rust }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Build all packages
      working-directory: ./backend
      run: cargo build --all-features --verbose

    - name: Build release mode
      working-directory: ./backend
      run: cargo build --release --all-features

  # ============================================================================
  # Job 6: Check Dependencies
  # ============================================================================
  dependencies:
    name: Check Dependencies
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@nightly

    - name: Install cargo-outdated
      run: cargo install cargo-outdated

    - name: Check for outdated dependencies
      working-directory: ./backend
      run: cargo outdated --exit-code 1 || true

  # ============================================================================
  # Summary Job - Required for branch protection
  # ============================================================================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [lint, test, security, build]
    if: always()
    
    steps:
    - name: Check all jobs
      run: |
        if [[ "${{ needs.lint.result }}" != "success" ]]; then
          echo "Lint job failed"
          exit 1
        fi
        if [[ "${{ needs.test.result }}" != "success" ]]; then
          echo "Test job failed"
          exit 1
        fi
        if [[ "${{ needs.security.result }}" != "success" ]]; then
          echo "Security job failed"
          exit 1
        fi
        if [[ "${{ needs.build.result }}" != "success" ]]; then
          echo "Build job failed"
          exit 1
        fi
        echo "All required jobs passed! âœ…"
